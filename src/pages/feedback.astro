---
import Layout from '../layouts/Layout.astro';
import Breadcrumb from '../components/Breadcrumb.astro';
import Alert from '../components/Alert.astro';

const currentUrl = Astro.url.pathname;
---

<Layout
	title="Feedback & Suggestions - Shemirat Enayim"
	description="Help us improve by sharing your feedback, reporting issues, or suggesting new features."
>
	<Breadcrumb />

	<div class="max-w-7xl mx-auto px-4 py-8 sm:px-6 lg:px-8">
		<header class="text-center mb-10">
			<h1 class="text-4xl font-extrabold text-gray-900 dark:text-white mb-3">Feedback & Suggestions</h1>
			<p class="text-xl text-gray-600 dark:text-gray-300 leading-relaxed">
				Your input helps us improve our resources and better serve families. We read every submission.
			</p>
		</header>

		<div class="grid grid-cols-1 lg:grid-cols-3 gap-10 items-start">
			<div class="lg:col-span-2 bg-white dark:bg-gray-800 border-2 border-gray-200 dark:border-gray-700 rounded-xl p-8 shadow-lg">
				<form class="flex flex-col gap-6" id="feedbackForm">
					<Alert type="info">
						<strong>Privacy Note:</strong> Email is optional. Provide it only if you'd like a response. We never share your information.
					</Alert>

					<!-- Feedback Type -->
					<div class="flex flex-col gap-2">
						<label for="feedbackType" class="font-semibold text-gray-900 dark:text-white text-base">
							<span class="mr-1">Feedback Type</span>
							<span class="text-red-600">*</span>
						</label>
						<select id="feedbackType" name="feedbackType" class="p-3 border-2 border-gray-300 dark:border-gray-600 rounded-lg text-base font-sans transition-all focus:outline-none focus:border-primary-500 focus:ring-4 focus:ring-primary-100 dark:bg-gray-700 dark:text-white" required>
							<option value="">Select type...</option>
							<option value="bug">üêõ Bug Report</option>
							<option value="feature">üí° Feature Request</option>
							<option value="content">üìù Content Correction</option>
							<option value="general">üí¨ General Feedback</option>
							<option value="question">‚ùì Question</option>
						</select>
					</div>

					<!-- Page URL (auto-populated, editable) -->
					<div class="flex flex-col gap-2">
						<label for="pageUrl" class="font-semibold text-gray-900 dark:text-white text-base">
							<span class="mr-1">Page URL</span>
						</label>
						<input
							type="url"
							id="pageUrl"
							name="pageUrl"
							class="p-3 border-2 border-gray-300 dark:border-gray-600 rounded-lg text-base font-sans transition-all focus:outline-none focus:border-primary-500 focus:ring-4 focus:ring-primary-100 dark:bg-gray-700 dark:text-white"
							placeholder="https://shemiratenayim.org/..."
						/>
						<p class="text-sm text-gray-500 dark:text-gray-400 m-0">Which page is this feedback about?</p>
					</div>

					<!-- Description -->
					<div class="flex flex-col gap-2">
						<label for="description" class="font-semibold text-gray-900 dark:text-white text-base">
							<span class="mr-1">Description</span>
							<span class="text-red-600">*</span>
						</label>
						<textarea
							id="description"
							name="description"
							class="p-3 border-2 border-gray-300 dark:border-gray-600 rounded-lg text-base font-sans transition-all resize-y min-h-[150px] leading-relaxed focus:outline-none focus:border-primary-500 focus:ring-4 focus:ring-primary-100 dark:bg-gray-700 dark:text-white"
							rows="8"
							required
							placeholder="Please describe your feedback in detail..."
						></textarea>
						<p class="text-sm text-gray-500 dark:text-gray-400 m-0">
							<span id="charCount">0</span> / 2000 characters
						</p>
					</div>

					<!-- Email (optional) -->
					<div class="flex flex-col gap-2">
						<label for="email" class="font-semibold text-gray-900 dark:text-white text-base">
							<span class="mr-1">Email (optional)</span>
						</label>
						<input
							type="email"
							id="email"
							name="email"
							class="p-3 border-2 border-gray-300 dark:border-gray-600 rounded-lg text-base font-sans transition-all focus:outline-none focus:border-primary-500 focus:ring-4 focus:ring-primary-100 dark:bg-gray-700 dark:text-white"
							placeholder="your@email.com"
						/>
						<p class="text-sm text-gray-500 dark:text-gray-400 m-0">Provide if you'd like a response</p>
					</div>

					<!-- Rating (optional) -->
					<div class="flex flex-col gap-2">
						<label class="font-semibold text-gray-900 dark:text-white text-base">
							<span class="mr-1">How helpful was this page?</span>
						</label>
						<div class="flex flex-col gap-2">
							<input type="radio" id="rating1" name="rating" value="1" class="absolute opacity-0" />
							<label for="rating1" class="p-3 px-4 border-2 border-gray-300 dark:border-gray-600 rounded-lg cursor-pointer transition-all font-medium hover:border-primary-500 hover:bg-primary-50 dark:hover:bg-primary-900/20 peer-checked:border-primary-600 peer-checked:bg-primary-100 dark:peer-checked:bg-primary-900/40 peer-checked:text-primary-900 dark:peer-checked:text-primary-100">‚≠ê 1 - Not helpful</label>

							<input type="radio" id="rating2" name="rating" value="2" class="absolute opacity-0" />
							<label for="rating2" class="p-3 px-4 border-2 border-gray-300 dark:border-gray-600 rounded-lg cursor-pointer transition-all font-medium hover:border-primary-500 hover:bg-primary-50 dark:hover:bg-primary-900/20">‚≠ê‚≠ê 2</label>

							<input type="radio" id="rating3" name="rating" value="3" class="absolute opacity-0" />
							<label for="rating3" class="p-3 px-4 border-2 border-gray-300 dark:border-gray-600 rounded-lg cursor-pointer transition-all font-medium hover:border-primary-500 hover:bg-primary-50 dark:hover:bg-primary-900/20">‚≠ê‚≠ê‚≠ê 3</label>

							<input for="rating4" id="rating4" name="rating" value="4" class="absolute opacity-0" />
							<label for="rating4" class="p-3 px-4 border-2 border-gray-300 dark:border-gray-600 rounded-lg cursor-pointer transition-all font-medium hover:border-primary-500 hover:bg-primary-50 dark:hover:bg-primary-900/20">‚≠ê‚≠ê‚≠ê‚≠ê 4</label>

							<input type="radio" id="rating5" name="rating" value="5" class="absolute opacity-0" />
							<label for="rating5" class="p-3 px-4 border-2 border-gray-300 dark:border-gray-600 rounded-lg cursor-pointer transition-all font-medium hover:border-primary-500 hover:bg-primary-50 dark:hover:bg-primary-900/20">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê 5 - Very helpful</label>
						</div>
					</div>

					<!-- Submit Button -->
					<div class="flex gap-3 mt-4">
						<button type="submit" class="flex-1 p-3 px-6 border-none rounded-lg font-semibold text-base cursor-pointer transition-all bg-primary-600 hover:bg-primary-700 text-white disabled:opacity-60 disabled:cursor-not-allowed hover:enabled:-translate-y-px hover:enabled:shadow-lg" id="submitBtn">
							<span>Submit Feedback</span>
						</button>
						<button type="reset" class="p-3 px-6 bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-200 border-2 border-gray-300 dark:border-gray-600 rounded-lg font-semibold text-base cursor-pointer transition-all hover:bg-gray-50 dark:hover:bg-gray-600 hover:border-gray-400 dark:hover:border-gray-500">
							Clear Form
						</button>
					</div>

					<!-- Form Messages -->
					<div id="formMessage" class="hidden p-4 rounded-lg mt-4 font-medium"></div>
				</form>
			</div>

			<aside class="flex flex-col gap-6">
				<div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl p-6 shadow-sm">
					<h2 class="text-xl font-bold text-gray-900 dark:text-white m-0 mb-4">üí° Tips for Good Feedback</h2>
					<ul class="m-0 pl-6">
						<li class="mb-2 text-gray-700 dark:text-gray-300 leading-relaxed"><strong>Be specific:</strong> Include details about what you experienced</li>
						<li class="mb-2 text-gray-700 dark:text-gray-300 leading-relaxed"><strong>Be constructive:</strong> Suggest improvements when possible</li>
						<li class="mb-2 text-gray-700 dark:text-gray-300 leading-relaxed"><strong>Include context:</strong> What were you trying to accomplish?</li>
						<li class="mb-2 text-gray-700 dark:text-gray-300 leading-relaxed"><strong>Report bugs clearly:</strong> Steps to reproduce, expected vs. actual results</li>
					</ul>
				</div>

				<div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl p-6 shadow-sm">
					<h2 class="text-xl font-bold text-gray-900 dark:text-white m-0 mb-4">üì¨ What Happens Next?</h2>
					<ol class="m-0 pl-6">
						<li class="mb-2 text-gray-700 dark:text-gray-300 leading-relaxed">We review every submission within 48 hours</li>
						<li class="mb-2 text-gray-700 dark:text-gray-300 leading-relaxed">Bug reports are prioritized for fixes</li>
						<li class="mb-2 text-gray-700 dark:text-gray-300 leading-relaxed">Feature requests are evaluated for implementation</li>
						<li class="mb-2 text-gray-700 dark:text-gray-300 leading-relaxed">If you provided email, we may reach out for clarification</li>
					</ol>
				</div>

				<div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl p-6 shadow-sm">
					<h2 class="text-xl font-bold text-gray-900 dark:text-white m-0 mb-4">üö® Urgent Issues?</h2>
					<p class="m-0 mb-3 text-gray-700 dark:text-gray-300 leading-relaxed">
						For technical problems preventing you from using filtering, see our
						<a href="/troubleshooting" class="text-primary-600 dark:text-primary-400 no-underline font-medium hover:underline">troubleshooting guides</a>.
					</p>
					<p class="m-0 mb-3 text-gray-700 dark:text-gray-300 leading-relaxed">
						For crisis situations, visit our
						<a href="/resources/emergency" class="text-primary-600 dark:text-primary-400 no-underline font-medium hover:underline">emergency resources</a>.
					</p>
				</div>

				<div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl p-6 shadow-sm">
					<h2 class="text-xl font-bold text-gray-900 dark:text-white m-0 mb-4">üìä Recent Improvements</h2>
					<p class="m-0 mb-3 text-gray-700 dark:text-gray-300 leading-relaxed">Thanks to user feedback, we recently:</p>
					<ul class="m-0 pl-6">
						<li class="mb-2 text-gray-700 dark:text-gray-300 leading-relaxed">Added 5 new troubleshooting guides</li>
						<li class="mb-2 text-gray-700 dark:text-gray-300 leading-relaxed">Improved search functionality</li>
						<li class="mb-2 text-gray-700 dark:text-gray-300 leading-relaxed">Created printable reference cards</li>
						<li class="mb-2 text-gray-700 dark:text-gray-300 leading-relaxed">Expanded FAQ with 36+ questions</li>
					</ul>
					<p class="m-0 mb-0 text-gray-700 dark:text-gray-300 leading-relaxed"><a href="/changelog" class="text-primary-600 dark:text-primary-400 no-underline font-medium hover:underline">View full changelog ‚Üí</a></p>
				</div>
			</aside>
		</div>
	</div>
</Layout>

<script>
	// Auto-populate page URL from referrer or current page
	const pageUrlInput = document.getElementById('pageUrl') as HTMLInputElement;
	if (pageUrlInput) {
		const referrer = document.referrer;
		if (referrer && referrer.includes(window.location.hostname)) {
			pageUrlInput.value = referrer;
		} else {
			pageUrlInput.value = window.location.href;
		}
	}

	// Character counter
	const textarea = document.getElementById('description') as HTMLTextAreaElement;
	const charCount = document.getElementById('charCount') as HTMLElement;

	if (textarea && charCount) {
		textarea.addEventListener('input', () => {
			const count = textarea.value.length;
			charCount.textContent = count.toString();

			if (count > 2000) {
				charCount.style.color = 'var(--color-error)';
				textarea.value = textarea.value.substring(0, 2000);
			} else {
				charCount.style.color = '';
			}
		});
	}

	// Form submission
	import { trackFeedbackSubmit } from '../utils/analytics';

	const form = document.getElementById('feedbackForm') as HTMLFormElement;
	const submitBtn = document.getElementById('submitBtn') as HTMLButtonElement;
	const formMessage = document.getElementById('formMessage') as HTMLElement;

	if (form) {
		form.addEventListener('submit', async (e) => {
			e.preventDefault();

			// Get form data
			const formData = new FormData(form);
			const data = Object.fromEntries(formData.entries());

			// Disable submit button
			submitBtn.disabled = true;
			submitBtn.innerHTML = '<span>Submitting...</span>';

			try {
				// In production, this would send to your backend API
				// For now, we'll simulate success after a delay
				await new Promise(resolve => setTimeout(resolve, 1500));

				// Track feedback submission
				const feedbackType = data.feedbackType as string;
				const rating = data.rating ? parseInt(data.rating as string) : undefined;
				trackFeedbackSubmit(feedbackType, rating);

				// Show success message
				formMessage.style.display = 'block';
				formMessage.className = 'block p-4 rounded-lg mt-4 font-medium bg-secondary-50 border-2 border-secondary-500 text-secondary-900';
				formMessage.textContent = '‚úì Thank you! Your feedback has been submitted successfully.';

				// Reset form
				form.reset();

				// Log to console (in production, this would go to your backend)
				console.log('Feedback submitted:', data);

				// Scroll to message
				formMessage.scrollIntoView({ behavior: 'smooth', block: 'nearest' });

			} catch (error) {
				// Show error message
				formMessage.style.display = 'block';
				formMessage.className = 'block p-4 rounded-lg mt-4 font-medium bg-red-50 border-2 border-red-500 text-red-900';
				formMessage.textContent = '‚úó Sorry, there was an error submitting your feedback. Please try again.';
			} finally {
				// Re-enable submit button
				submitBtn.disabled = false;
				submitBtn.innerHTML = '<span>Submit Feedback</span>';

				// Hide message after 5 seconds
				setTimeout(() => {
					formMessage.style.display = 'none';
				}, 5000);
			}
		});
	}
</script>
